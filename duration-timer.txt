' Script name: DuratronTimer
' This script calculates the remaining time of the current input and
' updates this time in the Text input named "Text Middle Centre Outline.gtzip".
' If the current input has no duration, it will start counting up.

Console.WriteLine("DurationTimer 1.0.0")

Dim position as double = 0
Dim duration as double = 0
Dim activeInput as string = ""
Dim timeLeft as double = 0
Dim yellowTime as integer = 60
Dim redTime as integer = 11

Do While True
    Sleep(300)

    Dim xml as string = API.XML()
    Dim x as new system.xml.xmldocument
    x.loadxml(xml)

    activeInput = (x.SelectSingleNode("//active").InnerText)
    Dim durationNode As XmlNode = x.SelectSingleNode("//input[@number='" & activeInput & "']/@duration")
    If durationNode IsNot Nothing Then
        duration = Double.Parse(durationNode.Value)
    Else
        Console.WriteLine("Node not found for activeInput: " & activeInput)
        duration = 0
    End If

    Dim positionNode As XmlNode = x.SelectSingleNode("//input[@number='"& activeInput &"']/@position")
    If positionNode IsNot Nothing Then
        position = Double.Parse(positionNode.Value)
    Else
        console.writeline("Node not found for activeInput: " & activeInput)
        position = 0
    End If


    If duration = 0
        API.Function("SetTextColour",Input:="Text Middle Centre Outline.gtzip", Value:="white")
        API.Function("StartCountdown",Input:="Text Middle Centre Outline.gtzip")
        continue do
    Else
        API.Function("StopCountdown",Input:="Text Middle Centre Outline.gtzip")
    End if

    timeLeft = duration - position

    timeLeft = timeLeft / 100

    Dim Timingleft as integer = CInt(timeLeft)
    Timingleft = Timingleft / 10

    Dim Minutes as integer = Timingleft \ 60
    Dim Seconds as integer = Timingleft Mod 60

    Dim ThisTime as string 
    ThisTime = Minutes.ToString("00") + ":" + Seconds.ToString("00")


    If Timingleft < yellowTime
       'put a response in a title and change color accordingly
  
        API.Function("SetText",Input:="Text Middle Centre Outline.gtzip",SelectedIndex:="0", Value:=Timingleft)
   
        If Timingleft < redTime
            API.Function("SetTextColour",Input:="Text Middle Centre Outline.gtzip", Value:="red")
        Else
            API.Function("SetTextColour",Input:="Text Middle Centre Outline.gtzip", Value:="orange")
        End If  
    Else
        API.Function("SetText",Input:="Text Middle Centre Outline.gtzip",SelectedIndex:="0", Value:=ThisTime)
        API.Function("SetTextColour",Input:="Text Middle Centre Outline.gtzip", Value:="green")
    End If
Loop
